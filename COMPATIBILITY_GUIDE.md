# ุฑุงูููุง ุณุงุฒฺฏุงุฑ ุจุง ููุทู ูุนู

ุงู ุณูุฏ ุงุทููุงู ูโุฏูุฏ ฺฉู ูุงฺูู ุฌุฏุฏ ุงูุจุงุฑุฏุงุฑ ุจุง ููุทู ูุนู ุณุณุชู ุณุงุฒฺฏุงุฑ ุงุณุช.

## โ 1. Flow ุณูุงุฑุด ุชุบุฑ ูฺฉุฑุฏู ุงุณุช

### ุจุฑุฑุณ Flow ูุนู:
- **ูุจู ุงุฒ ูุงฺูู ุฌุฏุฏ**: ุฏุฑ ููุทู ููุงโุดุฏู ุณูุงุฑุด (`completed` ุง `paid` ุง `delivered`)ุ ููุฌูุฏ ุงุฒ `inventory_items` ฺฉู ูโุดุฏ.
- **ุจุนุฏ ุงุฒ ูุงฺูู ุฌุฏุฏ**: ุฏุฑ ููุงู ููุทู ููุงโุดุฏูุ `consumeReservedInventory` ูุฑุงุฎูุงู ูโุดูุฏ ฺฉู:
  1. ุญุฑฺฉุช `SALE_CONSUMPTION` ุงุฌุงุฏ ูโฺฉูุฏ
  2. `inventory_balance` ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ
  3. `fifo_layers` ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ
  4. `inventory_items` ุฑุง ููฺฏุงูโุณุงุฒ ูโฺฉูุฏ

### ูุงูโูุง ูุฑุชุจุท:
- `app/api/orders/status/route.ts` (ุฎุท 168-191): Flow ุณูุงุฑุด ุจุฏูู ุชุบุฑ
- `app/api/inventory-reservations/helpers.ts` (ุฎุท 147-430): `consumeReservedInventory` ููุท ุฏุฑ ููุทู ููุงโุดุฏู ูุฑุงุฎูุงู ูโุดูุฏ

### ูุชุฌู:
โ **Flow ุณูุงุฑุด ุชุบุฑ ูฺฉุฑุฏู ุงุณุช** - ููุท ุฏุฑ ููุทู ููุงโุดุฏู ุญุฑฺฉุช `SALE_CONSUMPTION` ุงุฌุงุฏ ูโุดูุฏ.

---

## โ 2. ฺฉุดโูุง ูุฏู ุจุง ุชุฑฺฏุฑ ุงููุช ุจูโุฑูุฒุฑุณุงู ูโุดููุฏ

### ุณุณุชู ููฺฏุงูโุณุงุฒ:
1. **Event-Based System** (`lib/inventory-sync.ts`):
   - `inventorySync.emit()` ุจุฑุง ุงูุชุดุงุฑ events
   - `inventorySync.subscribe()` ุจุฑุง ฺฏูุด ุฏุงุฏู ุจู events
   - Events: `stock_movement_created`, `balance_updated`, `alert_updated`, `transfer_completed`, `count_approved`

2. **Helper Functions**:
   - `notifyStockMovement()`: ุจุนุฏ ุงุฒ ูุฑ ุญุฑฺฉุช ููุฌูุฏ
   - `notifyTransfer()`: ุจุนุฏ ุงุฒ ูุฑ ุงูุชูุงู
   - `notifyCountApproval()`: ุจุนุฏ ุงุฒ ูุฑ ุชุฃุฏ ุงูุจุงุฑฺฏุฑุฏุงู

3. **ููฺฏุงูโุณุงุฒ ุฎูุฏฺฉุงุฑ**:
   - ุจุนุฏ ุงุฒ ูุฑ ุญุฑฺฉุช ููุฌูุฏุ `inventory_items` ุงุฒ `inventory_balance` ููฺฏุงูโุณุงุฒ ูโุดูุฏ
   - `app/api/inventory/sync-balance/route.ts`: API ุจุฑุง ููฺฏุงูโุณุงุฒ ุฏุณุช
   - `lib/inventory-helpers.ts`: `syncInventoryFromBalance()` ุจุฑุง ููฺฏุงูโุณุงุฒ ุฎูุฏฺฉุงุฑ

### ูุงูโูุง ูุฑุชุจุท:
- `lib/inventory-sync.ts`: ุณุณุชู event-based
- `app/api/inventory-reservations/helpers.ts` (ุฎุท 369-391): ููฺฏุงูโุณุงุฒ `inventory_items` ุจุนุฏ ุงุฒ ูุตุฑู
- `app/api/inventory/stock-movements/route.ts`: ููฺฏุงูโุณุงุฒ ุจุนุฏ ุงุฒ ูุฑ ุญุฑฺฉุช
- `app/inventory/warehouses/page.tsx` (ุฎุท 375-403): ฺฏูุด ุฏุงุฏู ุจู events ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI

### ูุชุฌู:
โ **ฺฉุดโูุง ูุฏู ุจุง ุชุฑฺฏุฑ ุงููุช ุจูโุฑูุฒุฑุณุงู ูโุดููุฏ** - ุณุณุชู event-based ู ููฺฏุงูโุณุงุฒ ุฎูุฏฺฉุงุฑ ูุนุงู ุงุณุช.

---

## โ 3. ูุงูโูุง/ุดูุงุณูโูุง ูุนู ุญูุธ ุดุฏูโุงูุฏ

### ุดูุงุณูโูุง:
- **`itemId` ุฏุฑ `stock_movements`**: ููุงู `_id` ุงุฒ `inventory_items` (ObjectId)
- **`referenceId` ุฏุฑ `stock_movements`**: ุดูุงุณู ุณูุงุฑุด/ุงูุชูุงู/ุงูุจุงุฑฺฏุฑุฏุงู (ObjectId ุง string)
- **`warehouseName`**: ูุงู ุงูุจุงุฑ (string) - ุจุฏูู ุชุบุฑ
- **`orderNumber`**: ุดูุงุฑู ุณูุงุฑุด (string) - ุจุฏูู ุชุบุฑ

### ูุงูโูุง:
- **ูุงู ฺฉุงูุง**: ุงุฒ `inventory_items.name` ุฎูุงูุฏู ูโุดูุฏ
- **ูุงู ุงูุจุงุฑ**: ุงุฒ `warehouses.name` ุฎูุงูุฏู ูโุดูุฏ
- **ูุงู ุฏุณุชูโุจูุฏ**: ุงุฒ `inventory_items.category` ุฎูุงูุฏู ูโุดูุฏ

### ูุงูโูุง ูุฑุชุจุท:
- `app/api/inventory/stock-movements/route.ts` (ุฎุท 303-320): `itemId` ุจู ุตูุฑุช ObjectId ุฐุฎุฑู ูโุดูุฏ
- `app/api/inventory-reservations/helpers.ts` (ุฎุท 277-296): `itemId` ู `orderNumber` ุญูุธ ูโุดููุฏ
- `app/api/inventory/ledger/route.ts`: ฺฉุงุฑุฏฺฉุณ ุงุฒ `stock_movements` ุฎูุงูุฏู ูโุดูุฏ ู `itemId` ุฑุง ุจู `inventory_items` ุงุฑุฌุงุน ูโุฏูุฏ

### ูุชุฌู:
โ **ูุงูโูุง/ุดูุงุณูโูุง ูุนู ุญูุธ ุดุฏูโุงูุฏ** - ูุงฺูู ุงูุจุงุฑ ููุท ุจู ุขูโูุง ุงุฑุฌุงุน ูโุฏูุฏ.

---

## ๐ ุฎูุงุตู ุชุบุฑุงุช

### ุชุบุฑุงุช ุฏุฑ Flow ุณูุงุฑุด:
- โ **ูฺ ุชุบุฑ ุฏุฑ Flow ูุนู ุณูุงุฑุด ุฏุงุฏู ูุดุฏู ุงุณุช**
- โ ููุท ุฏุฑ ููุทู ููุงโุดุฏู (`completed` ุง `paid` ุง `delivered`)ุ ุญุฑฺฉุช `SALE_CONSUMPTION` ุงุฌุงุฏ ูโุดูุฏ

### ุชุบุฑุงุช ุฏุฑ ฺฉุด:
- โ ุณุณุชู event-based ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI
- โ ููฺฏุงูโุณุงุฒ ุฎูุฏฺฉุงุฑ `inventory_items` ุงุฒ `inventory_balance`
- โ ุชุฑฺฏุฑ events ุจุนุฏ ุงุฒ ูุฑ ุญุฑฺฉุช ููุฌูุฏ

### ุชุบุฑุงุช ุฏุฑ ุดูุงุณูโูุง:
- โ `itemId` ุฏุฑ `stock_movements` ููุงู `_id` ุงุฒ `inventory_items` ุงุณุช
- โ `referenceId` ุดูุงุณู ุณูุงุฑุด/ุงูุชูุงู/ุงูุจุงุฑฺฏุฑุฏุงู ุฑุง ุญูุธ ูโฺฉูุฏ
- โ ูุงูโูุง ู ฺฉุฏูุง ุจุฏูู ุชุบุฑ ุจุงู ูุงูุฏูโุงูุฏ

---

## ๐ ุจุฑุฑุณโูุง ูุงุฒู

### 1. ุจุฑุฑุณ Flow ุณูุงุฑุด:
```typescript
// app/api/orders/status/route.ts
// ุฎุท 168-191: ูุตุฑู ููุฌูุฏ ููุท ุฏุฑ ููุทู ููุงโุดุฏู
if ((oldStatus !== 'completed' && oldStatus !== 'paid' && oldStatus !== 'delivered') && 
    (newStatus === 'completed' || newStatus === 'paid' || newStatus === 'delivered')) {
  await consumeReservedInventory(...)
}
```

### 2. ุจุฑุฑุณ ููฺฏุงูโุณุงุฒ:
```typescript
// app/api/inventory-reservations/helpers.ts
// ุฎุท 369-391: ููฺฏุงูโุณุงุฒ inventory_items ุจุนุฏ ุงุฒ ูุตุฑู
await inventoryItemsCollection.updateOne(
  { _id: ingredientIdObj },
  { $set: { currentStock: newBalanceQty, ... } }
)
```

### 3. ุจุฑุฑุณ ุดูุงุณูโูุง:
```typescript
// app/api/inventory/stock-movements/route.ts
// ุฎุท 303-320: itemId ุจู ุตูุฑุช ObjectId ุฐุฎุฑู ูโุดูุฏ
const movement = {
  itemId: new ObjectId(itemId), // ููุงู _id ุงุฒ inventory_items
  referenceId: referenceId || null, // ุดูุงุณู ุณูุงุฑุด/ุงูุชูุงู
  orderNumber: orderNumber || null // ุดูุงุฑู ุณูุงุฑุด
}
```

---

## โ ูุชุฌูโฺฏุฑ

ููู ูฺฉุงุช ุณุงุฒฺฏุงุฑ ุฑุนุงุช ุดุฏูโุงูุฏ:

1. โ **Flow ุณูุงุฑุด ุชุบุฑ ูฺฉุฑุฏู** - ููุท ุฏุฑ ููุทู ููุงโุดุฏู ุญุฑฺฉุช `SALE_CONSUMPTION` ุงุฌุงุฏ ูโุดูุฏ
2. โ **ฺฉุดโูุง ูุฏู ุจุง ุชุฑฺฏุฑ ุงููุช ุจูโุฑูุฒุฑุณุงู ูโุดููุฏ** - ุณุณุชู event-based ู ููฺฏุงูโุณุงุฒ ุฎูุฏฺฉุงุฑ ูุนุงู ุงุณุช
3. โ **ูุงูโูุง/ุดูุงุณูโูุง ูุนู ุญูุธ ุดุฏูโุงูุฏ** - ูุงฺูู ุงูุจุงุฑ ููุท ุจู ุขูโูุง ุงุฑุฌุงุน ูโุฏูุฏ

**ูุงฺูู ุฌุฏุฏ ุงูุจุงุฑุฏุงุฑ ฺฉุงููุงู ุจุง ููุทู ูุนู ุณุณุชู ุณุงุฒฺฏุงุฑ ุงุณุช.** โ

